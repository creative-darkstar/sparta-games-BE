name: CD Pipeline

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main

jobs:
  # ë‚˜ì¤‘ì— ì“¸ ìˆ˜ ìžˆìŒ
  # ci:
  #   name: Run CI (PR only)
  #   if: github.event_name == 'pull_request'
  #   runs-on: ubuntu-latest

  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v3

  #   - name: Set up Python
  #     uses: actions/setup-python@v4
  #     with:
  #       python-version: '3.10.12'

  #   - name: Install dependencies
  #     run: |
  #       python -m venv venv
  #       source venv/bin/activate
  #       pip install --upgrade pip
  #       pip install -r requirements.txt
  #       pip install flake8 black

  #   - name: Check black formatting
  #     run: |
  #       source venv/bin/activate
  #       black --check .

  #   - name: Run flake8 linter
  #     run: |
  #       source venv/bin/activate
  #       flake8 .

  #   - name: Check for missing migrations
  #     run: |
  #       source venv/bin/activate
  #       python manage.py makemigrations --check --dry-run

  cd:
    name: Deploy to EC2 (push main + PR to main)
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
      (
        github.event_name == 'pull_request'
        && github.base_ref == 'main'
        && github.event.pull_request.head.repo.full_name == github.repository
      )
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup SSH
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_PEM }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

    - name: Deploy to EC2
      run: |
        ssh ${{ secrets.EC2_USERNAME }}@${{ secrets.EC2_HOST }} << EOF
          cd ${{ secrets.EC2_PROJECT_DIR }}
          git pull origin main
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          sudo systemctl restart daphne
          sudo systemctl restart nginx
          sudo supervisorctl restart all
        EOF

    - name: Notify to Discord
      # if: success() || failure()
      if: always()
      env:
        DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_GIT_DEPLOY_URL }}
      run: |
        STATUS="${{ job.status }}"
        COLOR="3066993"  # ì„±ê³µ: íŒŒëž‘
        ICON="âœ…"
        if [ "$STATUS" != "success" ]; then
          COLOR="15158332"  # ì‹¤íŒ¨: ë¹¨ê°•
          ICON="âŒ"
        fi

        DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        ACTOR="${{ github.actor }}"
        BRANCH="${GITHUB_REF#refs/heads/}"
        REPO="${{ github.repository }}"
        COMMIT_SHA="${{ github.sha }}"
        COMMIT_MSG="${{ github.event.head_commit.message }}"
        SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)

        jq -n --arg icon "$ICON" \
              --arg status "$STATUS" \
              --arg repo "$REPO" \
              --arg branch "$BRANCH" \
              --arg actor "$ACTOR" \
              --arg time "$DEPLOY_TIME" \
              --arg msg "$COMMIT_MSG" \
              --arg sha "$COMMIT_SHA" \
              --arg color "$COLOR" \
              '{
            embeds: [{
              title: "\($icon) CD ë°°í¬ ê²°ê³¼ (\($status))",
              description: "**[\($repo)]** ë¸Œëžœì¹˜ `\($branch)` ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.",
              color: ($color|tonumber),
              fields: [
                { name: "ðŸ‘¤ ë°°í¬ìž", value: $actor, inline: true },
                { name: "ðŸ•’ ë°°í¬ ì‹œê°„ (UTC)", value: $time, inline: true },
                { name: "ðŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€", value: $msg },
                { name: "ðŸ”— ì»¤ë°‹ ë§í¬", value: "https://github.com/\($repo)/commit/\($sha)" }
              ],
              timestamp: $time
            }]
          }' | curl -H "Content-Type: application/json" -X POST -d @- "$DISCORD_WEBHOOK_URL"


    # - name: Notify to Discord
    #   if: success() || failure()
    #   env:
    #     DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_GIT_DEPLOY_URL }}
    #   run: |
    #     STATUS="${{ job.status }}"
    #     COLOR="3066993"  # ì„±ê³µ: íŒŒëž‘
    #     ICON="âœ…"
    #     if [ "$STATUS" != "success" ]; then
    #       COLOR="15158332"  # ì‹¤íŒ¨: ë¹¨ê°•
    #       ICON="âŒ"
    #     fi

    #     DEPLOY_TIME=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    #     ACTOR="${{ github.actor }}"
    #     BRANCH="${GITHUB_REF#refs/heads/}"
    #     REPO="${{ github.repository }}"
    #     COMMIT_SHA="${{ github.sha }}"
    #     COMMIT_MSG="${{ github.event.head_commit.message }}"
    #     SHORT_SHA=$(echo "$COMMIT_SHA" | cut -c1-7)

    #     curl -H "Content-Type: application/json" \
    #         -X POST \
    #         -d "{
    #           \"embeds\": [{
    #             \"title\": \"$ICON CD ë°°í¬ ê²°ê³¼ ($STATUS)\",
    #             \"description\": \"**[$REPO]** ë¸Œëžœì¹˜ \`$BRANCH\` ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.\",
    #             \"color\": $COLOR,
    #             \"fields\": [
    #               {
    #                 \"name\": \"ðŸ‘¤ ë°°í¬ìž\",
    #                 \"value\": \"$ACTOR\",
    #                 \"inline\": true
    #               },
    #               {
    #                 \"name\": \"ðŸ•’ ë°°í¬ ì‹œê°„ (UTC)\",
    #                 \"value\": \"$DEPLOY_TIME\",
    #                 \"inline\": true
    #               },
    #               {
    #                 \"name\": \"ðŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€\",
    #                 \"value\": \"$COMMIT_MSG\"
    #               },
    #               {
    #                 \"name\": \"ðŸ”— ì»¤ë°‹ ë§í¬\",
    #                 \"value\": \"https://github.com/$REPO/commit/$COMMIT_SHA\"
    #               }
    #             ],
    #             \"timestamp\": \"$DEPLOY_TIME\"
    #           }]
    #         }" \
    #         "$DISCORD_WEBHOOK_URL"
